% fig_gac_framework.tex â€” GAC Framework Pipeline (simplified, no repair path)
% Usage: \input{figures/fig_gac_framework.tex}
\begin{figure*}[t]
\centering
\begin{tikzpicture}[scale=0.82, every node/.style={scale=0.82},
    >=stealth,
    % Colors
    cblue/.style={fill={rgb,255:red,55;green,131;blue,187}},
    cred/.style={fill={rgb,255:red,211;green,63;blue,73}},
    cgreen/.style={fill={rgb,255:red,56;green,158;blue,92}},
    corange/.style={fill={rgb,255:red,230;green,159;blue,0}},
    % Styles
    phase/.style={draw, rounded corners=5pt, minimum width=2.8cm, minimum height=1.8cm,
                  line width=0.9pt, font=\sffamily\small, align=center},
    iobox/.style={draw, rounded corners=5pt, minimum width=2.4cm, minimum height=1.6cm,
                  line width=0.9pt, font=\sffamily\small, align=center},
    arrow/.style={->, line width=1.6pt, color=gray!70!black},
    lbl/.style={font=\sffamily\scriptsize, align=center, text=gray!60!black},
  ]

  % Input
  \node[iobox, fill=gray!10, draw=gray!50] (input) at (0, 0) {
    \textbf{Input}\\[2pt]
    {\scriptsize Pre-trained LLM}\\[-1pt]
    {\scriptsize + budget $B$ + compressor}
  };

  % Step 1: Operator Analysis
  \node[phase, cblue, text=white] (analysis) at (4.2, 0) {
    \textbf{Operator Analysis}\\[2pt]
    {\scriptsize SDPA / GEMM / GeMV}\\[-1pt]
    {\scriptsize constraints (\S3)}
  };

  % Step 2: Dimension Sweep
  \node[phase, corange, text=white] (sweep) at (8.4, 0) {
    \textbf{Dimension Sweep}\\[2pt]
    {\scriptsize Profile near each $r_i^*$}\\[-1pt]
    {\scriptsize $\to$ candidate table $C_i$}
  };

  % Step 3: Knapsack DP
  \node[phase, fill=violet!70!blue, text=white] (dp) at (12.6, 0) {
    \textbf{Knapsack DP}\\[2pt]
    {\scriptsize $\max \sum f_i(r_i - r_i^*)$}\\[-1pt]
    {\scriptsize s.t.\ budget $B$}
  };

  % Output
  \node[iobox, fill=green!8, draw={rgb,255:red,56;green,158;blue,92}] (output) at (16.8, 0) {
    \textbf{Output}\\[2pt]
    {\scriptsize Aligned compressed}\\[-1pt]
    {\scriptsize model (100\% aligned)}
  };

  % Arrows
  \draw[arrow] (input) -- (analysis);
  \draw[arrow] (analysis) -- (sweep) node[midway, above=3pt, lbl] {constraints};
  \draw[arrow] (sweep) -- (dp) node[midway, above=3pt, lbl] {candidates};
  \draw[arrow] (dp) -- (output) node[midway, above=3pt, lbl] {optimal ranks};

  % Example annotation below
  \node[draw, rounded corners=3pt, fill=yellow!8, draw=orange!40, line width=0.6pt,
        font=\sffamily\scriptsize, align=left, text width=14.5cm]
    (example) at (8.4, -2.2) {
    \textbf{Example} ($W_3$, layer 7, k\_proj): \quad
    $r^* = 107.3$ \quad$\to$\quad
    candidates $C = \{96, 104, 112, 128\}$ \quad
    {\color{red!70!black}(107 excluded --- cuBLAS cliff)} \quad$\to$\quad
    DP picks $r = 104$ \quad
    {\color{gray}(saves budget for sensitive layers)}
  };
  \draw[->, line width=0.8pt, dashed, gray!50] (sweep.south) -- ([yshift=0.3cm]example.north -| sweep);

\end{tikzpicture}
\caption{\textbf{GAC framework.}
Three-step pipeline: (1)~Operator Analysis extracts alignment constraints from the full stack (\S\ref{sec:analysis});
(2)~Dimension Sweep profiles latency near each ideal rank $r_i^*$ to generate cliff-free candidate sets;
(3)~Knapsack DP selects one candidate per projection, maximizing Fisher-weighted information preservation under the parameter budget.
GAC wraps any existing compressor without modifying its core algorithm.}
\label{fig:gac_framework}
\end{figure*}
